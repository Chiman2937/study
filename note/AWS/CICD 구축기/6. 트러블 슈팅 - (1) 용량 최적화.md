# 문제 상황

빌드 파일을 EC2 서버에 업로드 할 때, 아래와 같이 용량 최적화를 진행했었다.

변경 전 용량
```
du -sh .[^.]* * 2>/dev/null | sort -hr
925M    node_modules
...
```

변경 후 용량
```
du -sh .[^.]* * 2>/dev/null | sort -hr
559M    node_modules
...
```

하지만 실제 PM2 프로세스가 실행된 후 다시 확인해보니, 용량이 원래대로 돌아가있는 것을 확인할 수 있었다.

<br></br>

## 원인 분석

### 1차 가설들 (모두 배제됨)
- **PM2가 자동으로 의존성 설치**: PM2는 단순 프로세스 관리자로 npm install 실행하지 않음
- **Next.js 런타임 의존성 설치**: `next start`는 이미 빌드된 앱만 실행
- **npm prune 타이밍 문제**: 로그 확인 결과 정상 동작(이미 npm prune 후 파일 압축 실행 중)


### 2차 가설 (부분적 원인)
- **프로세스 점유로 인한 파일 삭제 실패**: 이전 PM2 프로세스가 파일 사용 중일 때 완전 삭제되지 않음

```bash
# 수정 전: 폴더 삭제 후 프로세스 정리
sudo rm -rf "${APP_DIR}"
pm2 delete "preview-${BRANCH}" || true

# 수정 후: 프로세스 정리 후 폴더 삭제  
pm2 delete "preview-${BRANCH}" || true
sudo fuser -k ${FINAL_PORT}/tcp || true
sudo rm -rf "${APP_DIR}"
```

구문 순서를 수정해봤지만 해결이 되지 않았다.

<br></br>

## 최종 원인

next.config.ts 파일이 문제였다.

npm prune을 통해 프로덕션 의존성만 남기고 프로세스를 실행하는데, TypeScript는 `devDependencies`이다.

next config가 실행되면서 typescript가 감지되는데, typescript 패키지가 없으니 다시 npm install을 진행해버리는 것이었다.

### PM2 로그에서 발견된 증거
```
⚠ Installing TypeScript as it was not found while loading "next.config.ts".
299 packages are looking for funding
```

<br></br>

## 최종 해결책

- **패키징 로그 강화**: 각 단계별 용량 추적
- **프로세스 정리 순서 변경**: PM2 종료 → 폴더 삭제 → 새 배포
- **TypeScript 설정 파일 제외**: `next.config.js` 사용

<br></br>

## 교훈

### 디버깅 접근법
1. **로그 추적의 중요성**: GitHub Actions와 PM2 로그를 모두 확인
2. **가설 검증**: 각 가능성을 체계적으로 확인
3. **타임스탬프 분석**: 파일 수정 시간으로 정확한 원인 시점 파악

### Next.js 특성 이해
- TypeScript 설정 파일 사용 시 런타임에 의존성 자동 설치
- 프로덕션 환경에서는 JavaScript 설정 파일 사용 권장
- `next start`는 빌드된 결과만 실행하므로 추가 설치 없음

### 배포 최적화
- 개발 의존성과 프로덕션 의존성 명확한 분리
- 프로세스 생명주기 관리 (시작 전 완전 정리)
- 배포 과정의 각 단계별 검증 로그


<br></br>
---

## 관련 명령어

### 디버깅용
```bash
# 용량 확인
du -sh .[^.]* * | sort -hr

# 파일 정보
stat node_modules

# PM2 로그
pm2 logs preview-{branch-name}

# 프로세스 점유 확인
sudo lsof +D /path/to/directory
```

### 정리 작업
```bash
# PM2 프로세스 정리
pm2 delete all
pm2 flush  # 로그 정리

# 오래된 preview 폴더 정리
sudo rm -rf /var/www/preview/{old-branch-names}
