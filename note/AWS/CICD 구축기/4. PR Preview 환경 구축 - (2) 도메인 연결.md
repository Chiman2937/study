# 작업 현황

EC2 인스턴스의 public IPv4 주소의 각 포트번호 별로 프로세스를 실행시키는 부분까지 구현했다.
각 PR마다 다른 포트에서 애플리케이션이 실행되고 있었지만, 사용자가 IP 주소와 포트번호를 직접 입력해야 하는 불편함이 있었다.
또 EC2 인스턴스의 퍼블릭 IP에 직접 접근하는 방식이기 때문에 보안상 좋지 않다.

접속 주소
```
브랜치: chiyoung-test-pr
포트: 5214
접속 주소: http://3.39.20.13:5214 // 예시
```

## 구현 목표

구매한 도메인 `new-project-final.link`를 이용해 각 Preview 링크로 연결하는 작업을 구현하고자 했다.

| 구분 | 주소 |
| --- | --- |
|main 도메인 | `https://new-project-final.link` |
|preview 도메인 | `https://<branch_name>.preview.new-project-final.link` |

<br></br>

# 첫번째 시도: 도메인에 포트 직접 연결

구현목표를 떠나서 `new-project-final.link:5214` 이렇게 접속할 수는 없을까 라는 생각이 들었고

Route 53에 A 레코드를 설정하고 new-project-final.link:5214로 접근하는 방식을 시도해보았다.

```
Route 53 설정: new-project-final.link → 3.39.20.13
접근 시도: new-project-final.link:5214
```
하지만 EC2 보안그룹에서 `5214` 포트가 차단되어 있었기 때문에 이 방법은 사용할 수 없었다.

## 문제점 분석
### 보안그룹 관리의 복잡성
- 현재 보안그룹: HTTP(80), HTTPS(443) 포트만 개방
- PR마다 새로운 포트 추가 필요
- PR 삭제 시 포트 제거 작업 필요
- 포트 관리 자동화 스크립트 작성 필요

### 사용자 경험 문제

- 사용자가 포트번호를 기억해야 함
- 일반적이지 않은 URL 형태

<br></br>

# 해결책: Nginx Reverse Proxy

이런 문제들을 해결하기 위해 Nginx를 도입하기로 했다. Nginx의 Reverse Proxy 기능을 활용하면 80번 포트로 들어온 요청을 내부의 다양한 포트로 라우팅할 수 있다.

## 동작 원리

```
사용자 요청: chiyoung-test-pr.preview.new-project-final.link
       ↓
Route 53: 도메인을 EC2 IP로 변환
       ↓  
EC2 Nginx: server_name으로 적절한 설정 파일 선택
       ↓
Reverse Proxy: localhost:5214로 내부 전달
       ↓
애플리케이션: 5214 포트의 프로세스가 응답
```

## Route 53 와일드카드 설정

먼저 preview 도메인은 서브 도메인이므로 A 레코드를 별도로 등록해줘야하고,

preview 서브도메인은 브랜치명에 따라 동적으로 변하므로 와일드카드 레코드를 사용한다
```
레코드 타입: A
이름: *.preview.new-project-final.link
값: 3.39.20.13 (EC2 Public IP)
```

## Nginx 설정

브랜치별로 다음과 같은 nginx 설정 파일을 생성한다.
```
server {
    listen 80;
    server_name chiyoung-test-pr.preview.new-project-final.link;
    
    location / {
        proxy_pass http://127.0.0.1:5214;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

<br></br>

# Nginx Config 자동 설정 구현
브랜치별로 수동으로 config 파일을 생성하는 것은 비효율적이므로, PR-Deploy workflow에서 자동으로 생성되도록 구현했다.

먼저 프로젝트 내부에 deploy/preview.nginx.tpl 파일(템플릿)을 생성 해주었다.
```
server {
  listen 80;
  server_name ${BRANCH}.preview.${DOMAIN};

  location / {
      proxy_pass http://127.0.0.1:${FINAL_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

이 파일을 이용해 PR-Deploy workflow가 실행될 때마다 EC2 서버 내부에 config 파일을 생성해주면 된다.

```yml
# 1. 템플릿 파일을 EC2로 복사
scp -o StrictHostKeyChecking=no deploy/preview.nginx.tpl ubuntu@"${EC2_HOST}":/tmp/

# 2. 변수 주입하여 최종 nginx 설정 파일 생성
echo "[DEBUG][EC2] ⌛ Nginx 설정 생성 진행 중..."
if [ ! -f /tmp/preview.nginx.tpl ]; then
  echo "[FATAL] /tmp/preview.nginx.tpl not found"
  exit 1
fi

export BRANCH DOMAIN FINAL_PORT
envsubst "\$BRANCH \$DOMAIN \$FINAL_PORT" < /tmp/preview.nginx.tpl \
  | sudo tee /etc/nginx/conf.d/preview-${BRANCH}.conf >/dev/null
  
echo "[DEBUG][EC2] ✅ Nginx 설정 생성 완료"
```
- 파일 복사: 로컬의 템플릿 파일을 EC2 /tmp/ 디렉토리로 복사
- 변수 치환: envsubst로 ${BRANCH}, ${DOMAIN}, ${FINAL_PORT}를 실제 값으로 변경
- 설정 저장: nginx가 자동으로 인식하는 /etc/nginx/conf.d/ 디렉토리에 저장
- 파일명: preview-${BRANCH}.conf 형태로 브랜치별 구분

nginx 설정 구조
```
/etc/nginx/
├── nginx.conf (메인 설정 파일)
└── conf.d/ (추가 설정 파일들)
    ├── preview-chiyoung-test-pr.conf ← 여기에 저장
```

# 구현 결과

접속 예시
```
URL: chiyoung-test-pr.preview.new-project-final.link
내부 주소: localhost:5214
```

- 보안그룹 관리 단순화 (별도 추가 필요 X)
- 직관적인 URL 구조로 사용자 경험 개선
- PR 생성 시 nginx 설정 자동 생성
- 템플릿 기반으로 설정 표준화

```
PR 생성 → Workflow 실행 → 템플릿 복사 → 변수 주입 → nginx 설정 생성 → 도메인 접근 가능
```

이제 브랜치별 PR을 생성할 때마다 도메인으로 접속할 수 있는 환경이 구축되었다.
