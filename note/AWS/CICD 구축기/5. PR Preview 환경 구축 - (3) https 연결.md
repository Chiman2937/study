# https 연결

## HTTPS 적용의 필요성

HTTP로만 제공되는 Preview 링크를 보안이 강화된 HTTPS로 전환하여 실제 프로덕션 환경과 동일한 조건에서 테스트할 수 있도록 구현했다.

<br></br>

# Nginx Config에서 HTTPS 리다이렉트 구현

## HTTP → HTTPS 강제 리다이렉트 설정:

Preview 링크도 https 적용을 하려면 config 파일에서 https로 강제 redirect 하는 구문을 작성해주면 된다.

```
# 기존 HTTP 서버 블록을 리다이렉트로 변경
server {
    listen 80;
    server_name ${BRANCH}.preview.${DOMAIN};
    
    location / {
        return 301 https://$host$request_uri;  # HTTPS로 강제 리다이렉트
    }
}
```

이후에 proxy_pass 구문을 443 포트에서 처리하도록 만들면 되는데, 여기서 문제가 하나 생긴다.

ssl 인증서를 연결해줘야 https 접속이 가능한 문제였다.

```
# HTTPS 서버 블록
server {
  listen 443 ssl http2;
  server_name ${BRANCH}.preview.${DOMAIN};

```

<br></br>

# AWS ACM의 한계점
## AWS Certificate Manager (ACM) 검토:

### ✅ 무료 사용 조건:
- ALB, CloudFront, API Gateway 등 AWS 서비스 내에서만 사용
- 인증서가 AWS 인프라에 통합되어 관리됨

### ❌ EC2에서 직접 사용하려면:
- 유료 옵션: AWS Private CA를 통해 인증서 다운로드 가능
- 비용: Private CA 생성 시 월 $400 + 인증서 발급당 $0.75
- 복잡성: Private CA 설정 및 관리 필요

## ALB (Application Load Balancer) 검토:

- ✅ ACM 인증서 직접 적용 가능
- ❌ 시간당 요금 발생 (비용 부담)
- ❌ PR별 ALB 생성 시 관리 복잡성 증가

## CloudFront 검토:

- ✅ ACM 인증서 적용 가능
- ❌ CDN 서비스로 실시간 개발 환경에 부적합
- ❌ 캐싱으로 인한 변경사항 반영 지연

ACM을 무료로 사용할 때 ALB, CloudFront 둘 다 사용하기에 적합하지 않아서 다른 방법을 찾아보아야 했다.

<br></br>

# Let's Encrypt 솔루션 선택
## Let's Encrypt란?

비영리 기관에서 운영하는 무료 SSL 인증서 발급 서비스
자동화된 인증서 관리 지원
도메인 검증 방식으로 빠른 발급 가능

## 장단점 분석
### ✅ 장점:

- 완전 무료
- EC2에서 직접 사용 가능
- 와일드카드 인증서 지원
- 자동 갱신 가능

### ❌ 단점:
- 유효기간 3개월 (짧음)
- 주기적 갱신 로직 필요

따라서 Let's Encrypt 를 사용하여 주기적인 인증서 발급 로직을 적용하기로 결정했다.

<br></br>

# Let's Encrypt 인증서 발급

## 발급 과정:
```
certbot certonly --manual --preferred-challenges dns -d "*.preview.new-project-final.link"
```
- DNS TXT 레코드 생성 요구
- Route 53에서 TXT 레코드 추가
- 도메인 소유권 검증 완료
- 인증서 파일 생성

생성되는 파일들:
```
/etc/letsencrypt/live/new-project-final.link/
├── fullchain.pem    # 인증서 + 중간 인증서
├── privkey.pem      # 개인키
├── cert.pem         # 인증서만
└── chain.pem        # 중간 인증서만
```
## 인증서 자동 갱신 설정
유효기간 3개월 문제 해결

### 갱신 프로세스:
```
0 2 * * 0 certbot renew --quiet && systemctl reload nginx
```
- 매주 일요일 새벽 2시에 실행
- 만료 30일 전부터 자동 갱신 시도
- 갱신 성공 시 nginx 재로드로 새 인증서 적용

이제 SSL 인증서를 발급 받았으므로 HTTPS 서버 블록에서 인증서를 연결해주면 된다.

```
# HTTPS 서버 블록
server {
  listen 443 ssl http2;
  server_name ${BRANCH}.preview.${DOMAIN};

  # 인증서 경로 (Let's Encrypt 발급 후 동일 경로 사용)
  ssl_certificate /etc/letsencrypt/live/new-project-final.link/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/new-project-final.link/privkey.pem;

  # 보안 옵션 (권장)
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;

  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://127.0.0.1:${FINAL_PORT};
  }
}
```

# 최종 동작 흐름
```
사용자 접속: http://chiyoung-test-pr.preview.new-project-final.link
       ↓
HTTP 서버 블록: 301 리다이렉트
       ↓
HTTPS 재접속: https://chiyoung-test-pr.preview.new-project-final.link  
       ↓
HTTPS 서버 블록: SSL 인증서로 암호화 연결
       ↓
Reverse Proxy: localhost:5214로 내부 전달
       ↓
애플리케이션: 5214 포트에서 HTTPS 응답
```

# 구현 결과
달성한 목표:

- 모든 Preview 링크 HTTPS 강제 적용
- 비용 최적화 (무료 인증서 사용)
- 보안 강화 (TLS 1.2/1.3 지원)
- 자동 갱신으로 유지보수 최소화
- 와일드카드 인증서로 모든 서브도메인 커버

Let's Encrypt를 활용해 AWS의 제약사항을 우회하면서도 완전한 HTTPS 환경을 구축할 수 있었다.

특히 와일드카드 인증서를 사용함으로써 새로운 브랜치가 추가되어도 별도의 인증서 발급 없이 즉시 HTTPS를 지원할 수 있게 되었다.
