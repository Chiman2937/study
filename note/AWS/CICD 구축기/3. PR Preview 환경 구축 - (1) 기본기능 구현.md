# 작업 배경

Vercel에서는 branch에 push 할때마다 main 머지 전 Test를 해볼 수 있는 Preview 배포 환경을 제공한다.

그동안 Preview를 통해 미리 테스트 해볼 수 있는 환경의 중요성을 알았기 때문에 AWS 배포를 했어도 Preview 기능은 포기하고 싶지 않았다.

일단 AWS 배포를 했어도 Preview 기능은 Vercel을 이용해도 되긴 한다.

하지만 Preview와 Main의 배포환경이 달라지기 때문에 정확도가 떨어질 것이라고 생각했고... 인프라의 통합은 중요하다고 생각했다.

따라서 직접 Preview 환경을 직접 구현해보기로 했다.

<br></br>

# 구현 목표

구현 목표는 "branch에 따라 유동적인 Preview 환경 생성하기" 였다.
그러면 branch 별 EC2 서버 생성하는 방식은 사용하기 어렵다.

가장 첫번째로 떠오른 생각은 EC2서버에서 PM2 프로세스를 실행하니, branch별로 포트번호를 유동적으로 변경시켜서 별도의 프로세스를 운영하면 되지않을까? 였다.

<br></br>

# 1. branch 별 고유의 포트번호 생성하기

branch가 push 될때마다 고유한 포트번호를 생성한다면, random 함수를 사용해선 안되고 고유한 해시번호를 생성해야 한다.

linux에서 이와 같은 해시번호를 생성하는 기능을 지원한다.

```yml
# 2) 브랜치명 & 포트 계산
- name: Compute branch name & port
  id: meta
  run: |
    RAW="${{ github.ref_name }}"
    SANITIZED="$(echo "$RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')"
    PORT=$(( 5000 + $(echo -n "$SANITIZED" | cksum | awk '{print $1 % 1000}') ))
```
RAW: branch 이름
SANITIZED: branch이름을 소문자로 수정하며, 모든 특수문자를 - 로 변환한다.
PORT: cksum 함수를 이용해 고유한 해시번호를 생성한다. 이 때 0 ~ 1 사이로 생성되며 결과적으로 5000~5999 까지의 포트번호를 점유한다.

<br></br>

# 2. branch 별 고유의 포트번호로 프로세스 실행하기
```yml
pm2 start "node_modules/.bin/next start -p ${FINAL_PORT}" --name "preview-${BRANCH}"
```
next 프로젝트를 FINAL_PORT에 할당하여 PM2 프로세스를 실행하며, 이름은 `preview-<branch>` 로 지정한다.

<br></br>

# 결과물

예를 들어 `chiyoung-fix-lcp`라는 Branch는 해시번호 생성 구문에 의해 `5193` Port가 지정되고,
EC2 Public IPv4 주소의 해당 포트에 접속하면 Preview 링크에 접속이 가능해진다.

```
# 예시 주소
http://3.39.20.13:5913
```

https 연결에 대한 내용은 다음 글에서 이어진다.
