# 이미지 전송 개선

이미지 파일이 표시된 크기에 비해 너무 큰 사이즈로 다운로드 되는 현상이 있었다.

<img width="945" height="404" alt="image" src="https://github.com/user-attachments/assets/8ba725c2-6946-4935-9bb5-998a2fc39d47" />

<br></br>

## 문제 요소

<img width="876" height="768" alt="image" src="https://github.com/user-attachments/assets/6f1daf42-5473-46be-83d5-8d1cee7b1fb4" />

`ProductCard` 부분에서 해당 문제가 발생하고 있었어서, 코드를 확인해 보았다.

```tsx
<Image
  src={safeImageUrl}
  sizes='(max-width: 640px) 350px, (max-width: 1024px) 420px, 298px'
```
sizes props도 잘 지정되고 있었고, 반응형에 따라 사이즈가 잘 지정되어있었다.

하지만 dom 요소를 검사해보니 고유 크기가 750px로 지정되어 있는것을 알 수 있었고, 네트워크 탭에서도 서버에서 `w=750`으로 요청을 보내고 있었다.

> viewport는 420px로 지정 후 테스트 하였다.

<img width="372" height="232" alt="image" src="https://github.com/user-attachments/assets/ca2c1925-b299-4bc6-99cd-c0dc90dec09c" />

<img width="587" height="32" alt="image" src="https://github.com/user-attachments/assets/2a85887d-d63e-4ec9-85c9-379497723bbe" />

분명 sizes props가 제대로 지정되어있는데 최적화가 안되는 모습이라 관련 이슈가 있는지 찾아보았다.

일단 다른 수치도 아니고 750px로 지정되는 이유부터 찾아봐야 했다.

<br></br>

## next config의 최적화 테이블

아래는 Next image 최적화 테이블이다. sizes props에서 지정된 값보다 크거나 같은 값 중 가장 가까운 값이 지정되는 방식이다.

현재 viewport가 420px 이므로 최적화 요청 값인 350px과 가장 가까운 값인 384px가 지정되어야 하는데... 쌩뚱 맞게 750px으로 지정되고 있다.
```ts
  images: {
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
```

어쨌든 최적화 테이블에 지정된 값 중 하나인 750px로 최적화가 되고 있는 모습이어서 뭔가 다른 요소에 의해 조정 되고 있다고 생각해서 관련 이슈들을 찾아보았다.

<br></br>

## 관련 이슈

원문: https://github.com/vercel/next.js/issues/44244

이슈 내용 중 토론 내용을 보면 아래와 같은 글을 볼 수 있다.

---

I had the same issue and after two days of pulling my hair out, I concluded that this is a feature and not a bug… (Although I’m not sure all reported issues here are due to the same cause...)

As someone above already mentioned:
The Image component takes DPR into account. So if your viewport is 200px width and DPR is 2x, it will try to serve the image closest to 400px. The browser will default to your machines' resolution, which in my case is 2x (MacBook).

---

간단히 요약하자면, 이미지 최적화는 DPR을 고려한다는 내용이었다.

<br></br>

## 테스트

그래서 개발자 도구에서 DPR을 조정하여 테스트를 해보았고, 아래와 같은 결과를 얻을 수 있었다.

<img width="589" height="291" alt="image" src="https://github.com/user-attachments/assets/302271e7-885f-428f-a932-329374dd09e4" />

DPR에 따라 최적화 값이 달라지는 모습이다...

```tsx
<Image
  src={safeImageUrl}
  sizes='(max-width: 640px) 350px, (max-width: 1024px) 420px, 298px'
```

다시 코드를 확인해보면 테스트를 진행한 viewport 너비는 420px이다.

그러면 항상 350px로 최적화하도록 만들었는데, 이걸 Next image 최적화 테이블에 대입 해보면

| DPR Setting | 계산값 | 결과 |
| --- | --- | --- |
| 1 | 350px * 1 | 가장 가까운 값인 384px로 요청 |
| 2 | 350px * 2 | 가장 가까운 값인 750px로 요청 |
| 3 | 350px * 3 | 가장 가까운 값인 1080px로 요청 |

버그가 아니라 정상적인 동작이라는 결론이 나온다.

<br></br>

## 원인 재 분석
일단 750px로 요청되는 현상 자체는 버그가 아니라는 결론을 내릴 수 있다.

그렇다면 DPR 2 기준으로 요청되어도 과하지 않은 크기로 요청되도록 만들어야 하는데, 페이지의 특성에 대해 다시 생각해 볼 필요가 있었다.

### 데스크탑 디자인
<img width="1562" height="610" alt="image" src="https://github.com/user-attachments/assets/5932bcca-e0fe-4478-b37b-76b3bab0d9d6" />

### 태블릿/모바일 디자인
<img width="1562" height="570" alt="image" src="https://github.com/user-attachments/assets/ee04a644-799b-4552-b896-845141b214fe" />

데스크탑은 카드의 크기가 변하지 않지만

모바일/태블릿에서는 카드의 크기가 viewport의 너비에 따라서 유동적으로 변화하는 모습니다.

```tsx
<Image
  src={safeImageUrl}
  sizes='(max-width: 640px) 350px, (max-width: 1024px) 420px, 298px'
```

하지만 소스 코드에서는 모바일/태블릿 환경에서도 고정값으로 최적화하고 있는 것을 알 수 있다.

그러니까 viewport가 400px일때 이미지의 크기는 200px보다도 작아지지만 소스 이미지는 750px가 적용되고 있다고 분석할 수 있다.

모바일/태블릿 환경에서는 sizes가 vw단위로 지정되게 하면 이 문제를 해결할 수 있어 보인다.

```tsx
<Image
  src={safeImageUrl}
  sizes='(max-width: 1024px) 50vw, 300px'
```

그리고 현재 next image 최적화 테이블에서 384px과 640px 사이에는 breakpoint가 별도로 없어서 500px을 추가 해주었다.

```ts
images: {
  imageSizes: [16, 32, 48, 64, 96, 128, 256, 384, 500], //500 추가
  deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
},
```

breakpoint가 하나 더 추가 된 만큼 네트워크 비용이 증가하겠지만 불필요한 다른 breakpoint들을 정리해주어 이 문제도 해결할 수 있을 듯 하다.

이 작업은 LCP 개선 작업이 모두 완료 된 후에 진행하고자 한다.

<br></br>

# 결과

500px로 최적화 되게 만들 수 있었다.

<img width="500" height="309" alt="image" src="https://github.com/user-attachments/assets/ade05179-4bdb-4392-8b2e-ef6a4da8745b" />

원인 분석에 애를 조금 먹긴 했지만, next image의 동작 방식에 대해 한번 더 공부를 할 수 있는 시간이었던 것 같다.

또한.. 역시 이미지 최적화는 마법이 아니구나! 라는 것을 깨달았다.
