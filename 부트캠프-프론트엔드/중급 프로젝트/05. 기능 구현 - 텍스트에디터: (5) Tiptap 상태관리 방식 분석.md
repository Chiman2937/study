# 📝 기능 구현 - 텍스트에디터 (Tiptap의 상태 관리 방식 분석)

이전 문서에서는 Tiptap에서 제공하는 이미지 extension의 사용법에 대해 기술했다.

하지만 직접 사용해보는 과정에서 여러가지 문제점들을 느꼈고, 이에 대한 내용을 정리해보았다.

<br></br>

## 📜 사용자 경험에 기반한 분석

- `<img>` 태그만 다루며, 이미 주소가 있는 이미지만 경로로 지정가능하다. 즉, 주소가 없는 로컬 이미지를 사용할 수 없다는 문제가 있다.
- 이미지 사이즈 조절 기능을 지원하지 않는다.
- 드래그 앤 드롭을 지원하지 않아 줄 위치 변경을 할 수 없다.

<br></br>

## ❓ 해결 방법
단점을 해결하려면 이 기능들을 모두 지원하는 extension을 직접 만들어야한다.

Tiptap에서 Extension은 ProseMirror의 Schema, Plugin, Command 등을 포괄적으로 정의할 수 있는 확장 포맷이다.

직접 extension을 만들기 위해 Tiptap이 어떤식으로 상태를 관리하는지 분석할 필요가 있다고 느꼈다.

<br></br>

## 🔍 Tiptap의 상태 관리

Tiptap은 ProseMirror 프레임워크 기반으로 동작하는 라이브러리로, Tiptap의 상태관리는 전적으로 ProseMirror 프레임워크에 의존한다.

> ProseMirror에 대한 내용은 다음 장에서 기술한다.

## ❓ Tiptap extension 구조 분석
Tiptap에서 Node, Mark, Extension을 기반으로 커스텀 요소를 만들 때 `addAttributes`,`parseHTML`,`renderHTML`,`addNodeView` 메서드를 활용한다.

<br></br>

### 📌 addAttributes()
- Node, Mark에 커스텀 속성을 추가할 수 있는 메서드이다.
- HTML 속성이나 JS 객체에 값을 저장하고 이를 HTML 파싱이나 렌더링에 활용할 수 있도록 만들어준다.

```ts
addAttributes() {
  return {
    attrName: {
      default: null,
      parseHTML: element => element.getAttribute('attr-name'),
      renderHTML: attributes => {
        return { 'attr-name': attributes.attrName }
      }
    }
  }
}
```
> 이미지의 src, alt, width, aspect-ratio 속성 정의 등에 사용할 수 있다.

<br></br>

### 📌 parseHTML()
- 외부에서 HTML 문자열을 Tiptap 문서 상태(JSON 구조)로 파싱할 때 어떤 HTML 요소를 노드로 인식할지 정의합니다.
- 즉, HTML → ProseMirror Node 구조 변환 시 규칙을 명시한다.

```ts
parseHTML() {
  return [
    {
      tag: 'img[src]',
      getAttrs: element => ({
        src: element.getAttribute('src'),
        alt: element.getAttribute('alt'),
      })
    }
  ]
}
```

### 📌 renderHTML()
- ProseMirror 문서 상태 → HTML 문자열로 렌더링할 때의 출력 형태를 정의한다.
- 내부 JSON 구조를 기반으로 어떤 HTML로 렌더링할지 결정한다.

```ts
renderHTML({ HTMLAttributes }) {
  return ['img', HTMLAttributes]
}
```
> 커스텀 노드를 실제 HTML로 어떻게 보여줄지 정의
> 
> JSON 저장된 width, aspectRatio, data-* 속성 등을 HTML에 반영

<br></br>

### 📌 addNodeView()
- 노드를 직접 커스터마이징하여 React/Vue/Svelte 등 렌더링 프레임워크로 연결하거나, DOM 조작을 통해 고급 UI를 구현할 수 있게 해줍니다.

```ts
addNodeView() {
  return ({ node, getPos, editor }) => {
    const dom = document.createElement('div');
    dom.textContent = node.attrs.text;
    return {
      dom,
      contentDOM: null // 혹은 content 삽입을 위한 요소
    };
  }
}
```
> React 컴포넌트를 붙여서 동적 요소 렌더링
> 
> 커스텀 드래그 핸들 / 리사이징 기능 구현

<br></br>

## 📜 요약
| 메서드             | 시점                 | 목적                           |
| --------------- | ------------------ | ---------------------------- |
| `addAttributes` | 노드/마크 정의 시         | 속성 정의 및 HTML ↔ JSON 연동       |
| `parseHTML`     | HTML → JSON 변환 시   | HTML 요소를 내부 노드로 파싱           |
| `renderHTML`    | JSON → HTML 렌더링 시  | 내부 노드를 HTML 문자열로 변환          |
| `addNodeView`   | DOM 렌더링 단계 (클라이언트) | DOM/JSX를 통한 직접 렌더링 및 인터랙션 제공 |
