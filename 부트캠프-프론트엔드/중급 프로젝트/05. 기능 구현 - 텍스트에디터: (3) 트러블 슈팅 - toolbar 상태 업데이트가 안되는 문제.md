## 🔍 트러블 슈팅

<h3>❓ 스타일 선택 시 툴바의 상태가 업데이트 되지않는 문제</h3>

![Animation](https://github.com/user-attachments/assets/cc68e012-11dd-431c-bdb5-c02c1da0d4de)

> 예시: bold 버튼을 클릭해도 toolbar에는 active 스타일이 적용되지 않음(커서 이동시에도 동일) 

<br></br>

#### ⚠️ 원인: Tiptap의 상태 관리 구조 방식

Tiptap은 useState같은 React 상태 관리 구조를 사용하지 않으며, ProseMirror 관리 방식을 사용한다.

---

<details>

  <summary><strong>🧠 ProseMirror란?</strong></summary>

ProseMirror는 상태를 React의 useState 같은 방식으로 "자동 추적"하지 않고,
"명시적 불변 객체 트리(State) + 명령 기반 Transaction"으로 상태를 직접 관리하는 구조이다.

Tiptap은 단지 ProseMirror를 React에서 쓸 수 있게 감싼 wrapper일 뿐이고,
ProseMirror 내부는 명시적 트랜잭션 기반 구조라서 상태 변화도 직접 추적해야 한다.

> ProseMirror는 상태를 불변 객체(EditorState)로 관리하며, 모든 변경은 Transaction을 통해 이루어지는 명령 기반 구조이다.
자동 상태 추적과 리렌더링이 없는 대신, 매우 정밀하고 성능 지향적인 텍스트 에디터 제어가 가능하다.

---


| 항목    | React             | ProseMirror               |
| ----- | ----------------- | ------------------------- |
| 상태 변경 | `setState()`로 선언적 | `Transaction`으로 명령적으로     |
| 상태 추적 | 상태 바뀌면 자동 리렌더링    | 상태 바뀌어도 아무도 모름            |
| 리렌더링  | 자동                | 수동 (직접 감지 후 `setState`해야) |
| 상태 공유 | 훅이나 컨텍스트로 공유      | 플러그인 or 외부 리스너 필요         |

그래서 어떤 스타일을 선택했을 때 Tiptap 내부의 상태는 변경하지만, React가 이것을 감지하지 못해 리렌더링이 되지 않는 것이다.
  
</details>

<br></br>

#### 💡 해결방법

Tiptap 에디터와 상태 동기화를 어떻게 할 수 있는지 찾아보았다.
| 이벤트 이름            | 발생 조건                                     | 용도                                                    | 예시                                     |
| ----------------- | ----------------------------------------- | ----------------------------------------------------- | -------------------------------------- |
| `selectionUpdate` | **커서 위치 또는 선택 영역(selection)이 바뀔 때**       | 현재 selection에 따라 툴바 버튼(active 상태 등)을 갱신할 때 사용         | `isActive('bold')` 상태 갱신               |
| `transaction`     | **문서 상태가 변경될 때 (mark, node, attr 등)**     | 스타일 적용(굵게, 정렬, 리스트 등) 후에도 툴바 상태를 정확히 반영               | `setTextAlign('center')` 실행 직후 상태 업데이트 |
| `update`          | **EditorState 전체가 바뀔 때** (transaction 포함) | 전체 동기화용, 대체로 `transaction`과 유사하지만 selection 관련 반응은 없음 | 문서 전체의 구조를 분석할 때                       |
| `focus`           | 에디터에 포커스가 들어올 때                           | 포커스 여부로 UI 변경 시 사용                                    | 툴바 활성화, border 강조 등                    |
| `blur`            | 에디터에서 포커스가 빠질 때                           | 포커스 여부로 UI 변경 시 사용                                    | 툴바 숨기기 등                               |
| `destroy`         | 에디터 인스턴스가 파괴될 때                           | 클린업 로직 실행                                             | socket 연결 해제 등                         |
| `create`          | 에디터가 초기화될 때                               | 에디터 초기 설정 완료 후 초기 상태 가져오기                             | 초기 값 세팅                                |


<br></br>

이 이벤트들 전부 적용하는 것은 낭비이기 때문에 텍스트 에디터가 언제 업데이트 되어야 하는지를 먼저 고민해보았다.

- 커서가 이동했을 때(해당 위치의 노드의 스타일을 업데이트 해줘야함)
- toolbar에서 스타일을 선택한 직후

따라서 selectionUpdate와 transaction 이벤트 두가지를 사용해서 강제 업데이트 구문을 적용하기로 했다.

```tsx
  const [, forceUpdate] = useReducer((x) => x + 1, 0); // 강제 리렌더링을 위한 더미 상태

  useEffect(() => {
    if (!editor) return;
    const handler = () => {
      forceUpdate();
    };

    editor.on('transaction', handler);
    editor.on('selectionUpdate',handler);
    return () => {
      editor.off('transaction', handler);
      editor.off('selectionUpdate',handler);
    };
  }, [editor]);
```

이를 통해 화면이 강제 리렌더링 되도록 구현했다.

![Animation](https://github.com/user-attachments/assets/095a6d2c-ee88-4a77-9568-7f4b4a58b692)

이제 bold를 선택할때와 커서가 이동할 때 정상적으로 active상태가 반영된다.
